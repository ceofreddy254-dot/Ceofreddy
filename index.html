<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Loan Withdrawal Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">

  <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
    <h2 class="text-xl font-bold mb-4">Loan Withdrawal Test</h2>

    <label class="block mb-2">Phone Number</label>
    <input id="phone" type="text" class="w-full border rounded-lg px-3 py-2 mb-4">

    <label class="block mb-2">Amount</label>
    <input id="amount" type="number" class="w-full border rounded-lg px-3 py-2 mb-4">

    <button onclick="initiateWithdrawal()" 
            class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
      Withdraw
    </button>

    <div id="status" class="mt-4 text-gray-700"></div>
  </div>

  <!-- Receipt Modal -->
  <div id="receiptModal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Withdrawal Receipt</h3>
        <button onclick="closeReceiptModal()" class="text-gray-500 hover:text-gray-700">âœ–</button>
      </div>
      <div id="receiptContent" class="text-sm text-gray-700 space-y-2"></div>
      <div class="flex justify-end mt-6 space-x-3">
        <button onclick="downloadReceipt()" 
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          Download
        </button>
        <button onclick="closeReceiptModal()" 
                class="px-4 py-2 border rounded-lg hover:bg-gray-100">
          Close
        </button>
      </div>
    </div>
  </div>

  <script>
    async function initiateWithdrawal() {
      const phone = document.getElementById("phone").value;
      const amount = document.getElementById("amount").value;
      document.getElementById("status").innerText = "Processing...";

      try {
        const res = await fetch("https://dormainsearch.onrender.com/pay", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone, amount, loan_amount: amount })
        });

        const result = await res.json();
        if (!result.success) throw new Error(result.error || "Payment failed");

        document.getElementById("status").innerText = 
          "Withdrawal initiated. Waiting for receipt...";

        // After 7 seconds fetch receipt
        setTimeout(async () => {
          try {
            const rRes = await fetch(`https://dormainsearch.onrender.com/receipt/${result.reference}`);
            const rData = await rRes.json();

            if (rData.success) {
              const r = rData.receipt;
              const html = `
                <p><strong>Reference:</strong> ${r.reference}</p>
                <p><strong>Phone:</strong> ${r.phone}</p>
                <p><strong>Loan Amount:</strong> KES ${r.loan_amount}</p>
                <p><strong>Amount Paid:</strong> KES ${r.amount}</p>
                <p><strong>Status:</strong> ${r.status_message}</p>
                <p><strong>Date:</strong> ${new Date(r.timestamp).toLocaleString()}</p>
              `;
              document.getElementById("receiptContent").innerHTML = html;
              document.getElementById("receiptModal").classList.remove("hidden");
              document.getElementById("receiptModal").classList.add("flex");
            } else {
              document.getElementById("status").innerText = "Receipt not found.";
            }
          } catch (err) {
            document.getElementById("status").innerText = "Error fetching receipt: " + err.message;
          }
        }, 7000);

      } catch (err) {
        document.getElementById("status").innerText = "Error: " + err.message;
      }
    }

    function closeReceiptModal() {
      document.getElementById("receiptModal").classList.add("hidden");
      document.getElementById("receiptModal").classList.remove("flex");
    }

    function downloadReceipt() {
      const content = document.getElementById("receiptContent").innerText;
      const blob = new Blob([content], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "receipt.txt";
      link.click();
    }
  </script>
</body>
</html>
